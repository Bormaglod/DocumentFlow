{
  "name": "ready_goods",
  "viewer": {
    "dataset": {
      "select": "select rg.id, rg.status_id, s.note as status_name, ua.name as user_created, po.doc_date as order_date, po.view_number as order_number, rg.doc_date, rg.view_number, o.name as organization_name, g.name as goods_name, rg.amount, rg.price, rg.cost, c.name as contractor_name from ready_goods rg join status s on (s.id = rg.status_id) join user_alias ua on (ua.id = rg.user_created_id) join organization o on (o.id = rg.organization_id) left join goods g on (g.id = rg.goods_id) left join production_order po on (po.id = rg.owner_id) left join contractor c on (c.id = po.contractor_id) where rg.doc_date between :from_date and :to_date and rg.organization_id = :organization_id",
      "select-id": "select rg.id, rg.status_id, s.note as status_name, ua.name as user_created, po.doc_date as order_date, po.view_number as order_number, rg.doc_date, rg.view_number, o.name as organization_name, g.name as goods_name, rg.amount, rg.price, rg.cost, c.name as contractor_name from ready_goods rg join status s on (s.id = rg.status_id) join user_alias ua on (ua.id = rg.user_created_id) join organization o on (o.id = rg.organization_id) left join goods g on (g.id = rg.goods_id) left join production_order po on (po.id = rg.owner_id) left join contractor c on (c.id = po.contractor_id) where rg.id = :id"
    },
    "data-type": "Document",
    "allow-grouping": true,
    "from-date": "FirstYearDay",
    "to-date": "LastYearDay",
    "columns": [
      {
        "datafield": "id",
        "text": "Id",
        "type": "Text",
        "width": 180,
        "visible": false
      },
      {
        "datafield": "status_id",
        "text": "Код состояния",
        "type": "Integer",
        "width": 80,
        "visible": false,
        "allow-grouping": true
      },
      {
        "datafield": "status_name",
        "text": "Состояние",
        "type": "Text",
        "width": 110,
        "visible": false,
        "allow-grouping": true
      },
      {
        "datafield": "user_created",
        "text": "Автор",
        "type": "Text",
        "width": 110,
        "visible": false,
        "allow-grouping": true
      },
      {
        "datafield": "doc_date",
        "text": "Дата",
        "type": "Date",
        "width": 150,
        "hideable": false
      },
      {
        "datafield": "view_number",
        "text": "Номер",
        "type": "Text",
        "width": 100
      },
      {
        "datafield": "organization_name",
        "text": "Организация",
        "type": "Text",
        "width": 150,
        "visible": false,
        "allow-grouping": true
      },
      {
        "datafield": "order_date",
        "text": "Дата",
        "type": "Date",
        "width": 150
      },
      {
        "datafield": "order_number",
        "text": "Номер",
        "type": "Text",
        "width": 100
      },
      {
        "datafield": "contractor_name",
        "text": "Контрагент",
        "type": "Text",
        "width": 150,
        "allow-grouping": true
      },
      {
        "datafield": "goods_name",
        "text": "Изделие",
        "type": "Text",
        "auto-size": true,
        "allow-grouping": true
      },
      {
        "datafield": "amount",
        "text": "Количество",
        "type": "Numeric",
        "width": 120,
        "digits": 3,
        "horizontal-align": "Right"
      },
      {
        "datafield": "price",
        "text": "Цена",
        "type": "Numeric",
        "width": 100,
        "format-mode": "Currency",
        "horizontal-align": "Right"
      },
      {
        "datafield": "cost",
        "text": "Стоимость",
        "type": "Numeric",
        "width": 100,
        "format-mode": "Currency",
        "horizontal-align": "Right"
      }
    ],
    "stacked-columns": [
      {
        "header": "Заказ",
        "childs": [ "order_date", "order_number", "contractor_name" ]
      }
    ],
    "sorts": [
      {
        "name": "doc_date",
        "direction": "Descending"
      }
    ]
  },
  "editor": {
    "dataset": {
      "select": "select id, owner_id, doc_date, doc_number, goods_id, amount, price, cost from ready_goods where id = :id",
      "update": "update ready_goods set doc_date = :doc_date, goods_id = :goods_id, amount = :amount, price = :price, cost = :cost where id = :id"
    },
    "controls": [
      {
        "type": "SelectBox",
        "text": "Заказ на изготовление",
        "datafield": "owner_id",
        "label-width": 190,
        "edit-width": 350,
        "dataset": "select po.id, po.status_id, '№' || po.view_number || ' от ' || to_char(po.doc_date, 'DD.MM.YYYY') as name from production_order po where po.status_id = 3100 or po.id = :owner_id",
        "expressions": [
          {
            "expression": "Populate(\"goods_id\"; true)"
          }
        ]
      },
      {
        "type": "DateTime",
        "text": "Дата изготовления",
        "datafield": "doc_date",
        "label-width": 190,
        "edit-width": 170
      },
      {
        "type": "SelectBox",
        "text": "Изделие",
        "datafield": "goods_id",
        "label-width": 190,
        "edit-width": 300,
        "dataset": "with recursive r as (select id, status_id, name, parent_id from goods where id = '4da429d1-cd8f-4757-bea8-49c99adc48d8' union all select g.id, g.status_id, g.name, g.parent_id from goods g join r on (r.id = g.parent_id and g.status_id = 500)) select id, status_id, name, parent_id from r union all select g.id, g.status_id, g.name, g.parent_id from goods g join production_order_detail pod on (pod.owner_id = :owner_id and pod.goods_id = g.id) order by name"
      },
      {
        "type": "Numeric",
        "text": "Количество",
        "decimal-digits": 3,
        "datafield": "amount",
        "label-width": 190
      },
      {
        "type": "Currency",
        "text": "Цена",
        "datafield": "price",
        "label-width": 190
      },
      {
        "type": "Currency",
        "text": "Сумма",
        "datafield": "cost",
        "label-width": 190
      }
    ],
    "conditions": [
      {
        "controls": [ "owner_id", "doc_date", "date_debited", "goods_id", "amount", "price", "cost" ],
        "enable": {
          "states": [ "compiled", "is changing" ]
        }
      }
    ]
  }
}