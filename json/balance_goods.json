{
  "name": "balance_goods",
  "viewer": {
    "dataset": {
      "select": "select bg.id, bg.status_id, s.note as status_name, case when bg.owner_id is null then 'Начальный остаток' else bg.document_name end, bg.document_date, bg.document_number, case when bg.operation_summa > 0::money then bg.operation_summa else null end as income, case when bg.operation_summa < 0::money then (@bg.operation_summa::numeric)::money else null end as expense, bg.amount, g.name as goods_name, sum(bg.amount * sign(bg.operation_summa::numeric)) over (order by document_date, document_number) as remainder from balance_goods bg join status s on (s.id = bg.status_id) left join goods g on (g.id = bg.reference_id) where bg.reference_id = :owner_id order by bg.document_date desc, bg.order_index desc",
      "select-id": "select bg.id, bg.status_id, s.note as status_name, case when bg.owner_id is null then 'Начальный остаток' else bg.document_name end, bg.document_date, bg.document_number, case when bg.operation_summa > 0::money then bg.operation_summa else null end as income, case when bg.operation_summa < 0::money then (@bg.operation_summa::numeric)::money else null end as expense, bg.amount, g.name as goods_name, sum(bg.amount * sign(bg.operation_summa::numeric)) over (order by document_date, document_number) as remainder from balance_goods bg join status s on (s.id = bg.status_id) left join goods g on (g.id = bg.reference_id) where bg.id = :id"
    },
    "data-type": "Directory",
    "toolbar": {
      "button-style": "Image",
      "icon-size": "Small"
    },
    "commandbar-visible": false,
    "allow-sorting": false,
    "columns": [
      {
        "datafield": "id",
        "text": "Id",
        "type": "Text",
        "width": 180,
        "visible": false
      },
      {
        "datafield": "status_id",
        "text": "Код состояния",
        "type": "Integer",
        "width": 80,
        "visible": false
      },
      {
        "datafield": "status_name",
        "text": "Состояние",
        "type": "Text",
        "width": 110,
        "visible": false
      },
      {
        "datafield": "document_name",
        "text": "Документ",
        "type": "Text",
        "auto-size": true
      },
      {
        "datafield": "document_date",
        "text": "Дата",
        "type": "Date",
        "hideable": false,
        "width": 150
      },
      {
        "datafield": "document_number",
        "text": "Номер",
        "type": "Text",
        "width": 150
      },
      {
        "datafield": "income",
        "text": "Приход",
        "type": "numeric",
        "format-mode": "Currency",
        "horizontal-align": "Right"
      },
      {
        "datafield": "expense",
        "text": "Расход",
        "type": "numeric",
        "format-mode": "Currency",
        "horizontal-align": "Right"
      },
      {
        "datafield": "amount",
        "text": "Количество",
        "type": "numeric",
        "digits": 3,
        "horizontal-align": "Right",
        "width": 130
      },
      {
        "datafield": "remainder",
        "text": "Остаток",
        "type": "numeric",
        "digits": 3,
        "horizontal-align": "Right",
        "width": 130,
        "background-color": "#DAE5F5"
      }
    ]
  },
  "editor": {
    "dataset": {
      "generate-defaults": false,
      "insert": "insert into balance_goods (reference_id) values (:owner_id) returning id",
      "select": "select bg.id, bg.operation_summa, bg.amount, bg.document_date, g.name as goods_name, bg.document_name, bg.document_number from balance_goods bg join goods g on (g.id = bg.reference_id) where bg.id = :id",
      "update": "update balance_goods set operation_summa = :operation_summa, amount = :amount, document_date = :document_date where id = :id"
    },
    "controls": [
      {
        "type": "TextBox",
        "text": "Материал",
        "datafield": "goods_name",
        "label-width": 120,
        "edit-width": 400,
        "enabled": false
      },
      {
        "type": "TextBox",
        "text": "Документ",
        "datafield": "document_name",
        "label-width": 120,
        "edit-width": 250,
        "enabled": false
      },
      {
        "type": "TextBox",
        "text": "Номер",
        "datafield": "document_number",
        "label-width": 120,
        "enabled": false
      },
      {
        "type": "DateTime",
        "text": "Дата",
        "datafield": "document_date",
        "label-width": 120,
        "edit-width": 170
      },
      {
        "type": "Currency",
        "text": "Нач. остаток",
        "datafield": "operation_summa",
        "label-width": 120,
        "edit-width": 150
      },
      {
        "type": "Numeric",
        "text": "Количество",
        "datafield": "amount",
        "decimal-digits": 3,
        "label-width": 120,
        "edit-width": 150
      }
    ],
    "conditions": [
      {
        "controls": [ "document_date", "operation_summa", "amount" ],
        "enable": {
          "states": [ "compiled", "initial balance" ]
        }
      },
      {
        "controls": [ "document_name", "document_number" ],
        "visible": {
          "states": [ "current balance" ]
        }
      }
    ]
  }
}